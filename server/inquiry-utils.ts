import ExcelJS from 'exceljs';
import type { Inquiry, User } from '../drizzle/schema';

interface InquiryItem {
  id: number;
  productId: number;
  quantity: number;
  notes: string | null;
  product: {
    id: number;
    productId: string;
    partNumber: string;
    brand: string;
    name: string | null;
    description: string | null;
  } | null;
}

/**
 * Generate Excel file for inquiry
 */
export async function generateInquiryExcel(
  inquiry: Inquiry,
  items: InquiryItem[],
  user: User
): Promise<Buffer> {
  const workbook = new ExcelJS.Workbook();
  const worksheet = workbook.addWorksheet('Inquiry');

  // Set column widths
  worksheet.columns = [
    { width: 5 },   // No.
    { width: 25 },  // Product ID
    { width: 20 },  // Brand
    { width: 20 },  // Part Number
    { width: 35 },  // Product Name
    { width: 10 },  // Quantity
    { width: 30 },  // Notes
  ];

  // Header Section
  worksheet.mergeCells('A1:G1');
  const titleRow = worksheet.getCell('A1');
  titleRow.value = 'ROWELL HPLC - Product Inquiry';
  titleRow.font = { size: 16, bold: true };
  titleRow.alignment = { horizontal: 'center', vertical: 'middle' };
  worksheet.getRow(1).height = 30;

  // Inquiry Information
  worksheet.addRow([]);
  worksheet.addRow(['Inquiry Number:', inquiry.inquiryNumber]);
  worksheet.addRow(['Date:', new Date(inquiry.createdAt).toLocaleString()]);
  worksheet.addRow(['Status:', inquiry.status.toUpperCase()]);
  worksheet.addRow(['Urgency:', inquiry.urgency.replace('_', ' ').toUpperCase()]);
  
  // Customer Information
  worksheet.addRow([]);
  worksheet.addRow(['CUSTOMER INFORMATION']);
  worksheet.getCell('A8').font = { bold: true, size: 12 };
  worksheet.addRow(['Name:', user.name || 'N/A']);
  worksheet.addRow(['Email:', user.email || 'N/A']);
  worksheet.addRow(['Company:', user.company || 'N/A']);
  worksheet.addRow(['Phone:', user.phone || 'N/A']);
  worksheet.addRow(['Country:', user.country || 'N/A']);

  // Inquiry Details
  if (inquiry.budgetRange || inquiry.applicationNotes || inquiry.deliveryAddress || inquiry.customerNotes) {
    worksheet.addRow([]);
    worksheet.addRow(['INQUIRY DETAILS']);
    worksheet.getCell(`A${worksheet.lastRow!.number}`).font = { bold: true, size: 12 };
    
    if (inquiry.budgetRange) {
      worksheet.addRow(['Budget Range:', inquiry.budgetRange]);
    }
    if (inquiry.applicationNotes) {
      worksheet.addRow(['Application Notes:', inquiry.applicationNotes]);
    }
    if (inquiry.deliveryAddress) {
      worksheet.addRow(['Delivery Address:', inquiry.deliveryAddress]);
    }
    if (inquiry.customerNotes) {
      worksheet.addRow(['Additional Notes:', inquiry.customerNotes]);
    }
  }

  // Products Table
  worksheet.addRow([]);
  const productsHeaderRow = worksheet.addRow(['PRODUCTS']);
  productsHeaderRow.getCell(1).font = { bold: true, size: 12 };
  
  // Table Header
  const tableHeaderRow = worksheet.addRow([
    'No.',
    'Product ID',
    'Brand',
    'Part Number',
    'Product Name',
    'Quantity',
    'Notes'
  ]);
  
  tableHeaderRow.eachCell((cell) => {
    cell.font = { bold: true };
    cell.fill = {
      type: 'pattern',
      pattern: 'solid',
      fgColor: { argb: 'FFE0E0E0' }
    };
    cell.border = {
      top: { style: 'thin' },
      left: { style: 'thin' },
      bottom: { style: 'thin' },
      right: { style: 'thin' }
    };
  });

  // Table Data
  items.forEach((item, index) => {
    const row = worksheet.addRow([
      index + 1,
      item.product?.productId || 'N/A',
      item.product?.brand || 'N/A',
      item.product?.partNumber || 'N/A',
      item.product?.name || 'N/A',
      item.quantity,
      item.notes || ''
    ]);

    row.eachCell((cell) => {
      cell.border = {
        top: { style: 'thin' },
        left: { style: 'thin' },
        bottom: { style: 'thin' },
        right: { style: 'thin' }
      };
    });
  });

  // Summary
  worksheet.addRow([]);
  worksheet.addRow(['Total Items:', items.length]);
  worksheet.getCell(`A${worksheet.lastRow!.number}`).font = { bold: true };

  // Footer
  worksheet.addRow([]);
  worksheet.addRow([]);
  const footerRow = worksheet.addRow(['Generated by ROWELL HPLC Inquiry System']);
  footerRow.getCell(1).font = { italic: true, size: 10 };
  footerRow.getCell(1).alignment = { horizontal: 'center' };
  worksheet.mergeCells(`A${footerRow.number}:G${footerRow.number}`);

  // Generate buffer
  const buffer = await workbook.xlsx.writeBuffer();
  return Buffer.from(buffer);
}

/**
 * Send inquiry email notification using SendGrid
 */
export async function sendInquiryEmail(
  inquiry: Inquiry,
  user: User,
  excelBuffer: Buffer
): Promise<boolean> {
  try {
    const sgMail = await import('@sendgrid/mail');
    sgMail.default.setApiKey(process.env.SENDGRID_API_KEY || '');

    const fromEmail = process.env.SENDGRID_FROM_EMAIL || 'info@rowellhplc.com';
    const toEmail = 'info@rowellhplc.com';

    // Create HTML email content
    const htmlContent = `
      <!DOCTYPE html>
      <html>
      <head>
        <style>
          body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; max-width: 800px; margin: 0 auto; }
          .header { background-color: #2c7da0; color: white; padding: 30px; text-align: center; }
          .header img { max-width: 200px; height: auto; }
          .header h1 { margin: 15px 0 0 0; font-size: 24px; }
          .content { padding: 30px; background-color: #f9f9f9; }
          .info-section { margin: 20px 0; padding: 20px; background-color: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
          .info-label { font-weight: bold; color: #2c7da0; display: inline-block; min-width: 150px; }
          .info-value { color: #333; }
          .section-title { color: #2c7da0; font-size: 18px; font-weight: bold; margin: 20px 0 10px 0; border-bottom: 2px solid #2c7da0; padding-bottom: 5px; }
          .products-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
          .products-table th { background-color: #2c7da0; color: white; padding: 12px; text-align: left; }
          .products-table td { padding: 10px; border-bottom: 1px solid #ddd; }
          .products-table tr:hover { background-color: #f5f5f5; }
          .footer { margin-top: 30px; padding: 20px; background-color: #f5f5f5; text-align: center; font-size: 12px; color: #666; }
          .whatsapp-section { margin-top: 20px; padding: 15px; background-color: #25D366; color: white; border-radius: 8px; text-align: center; }
          .whatsapp-section a { color: white; text-decoration: none; font-weight: bold; }
        </style>
      </head>
      <body>
        <div class="header">
          <h1>üîî New Inquiry Received</h1>
        </div>
        <div class="content">
          <div class="info-section">
            <h2 class="section-title">Inquiry Information</h2>
            <p><span class="info-label">Inquiry Number:</span> <span class="info-value">${inquiry.inquiryNumber}</span></p>
            <p><span class="info-label">Date:</span> <span class="info-value">${new Date(inquiry.createdAt).toLocaleString()}</span></p>
            <p><span class="info-label">Status:</span> <span class="info-value">${inquiry.status.toUpperCase()}</span></p>
            <p><span class="info-label">Urgency:</span> <span class="info-value" style="color: ${inquiry.urgency === 'very_urgent' ? '#dc2626' : inquiry.urgency === 'urgent' ? '#ea580c' : '#059669'}; font-weight: bold;">${inquiry.urgency.replace('_', ' ').toUpperCase()}</span></p>
          </div>
          
          <div class="info-section">
            <h2 class="section-title">Customer Information</h2>
            <p><span class="info-label">Name:</span> <span class="info-value">${user.name || 'N/A'}</span></p>
            <p><span class="info-label">Email:</span> <span class="info-value">${user.email || 'N/A'}</span></p>
            <p><span class="info-label">Company:</span> <span class="info-value">${user.company || 'N/A'}</span></p>
            <p><span class="info-label">Phone:</span> <span class="info-value">${user.phone || 'N/A'}</span></p>
            <p><span class="info-label">Country:</span> <span class="info-value">${user.country || 'N/A'}</span></p>
            <p><span class="info-label">Industry:</span> <span class="info-value">${user.industry || 'N/A'}</span></p>
          </div>

          ${inquiry.budgetRange || inquiry.applicationNotes || inquiry.deliveryAddress ? `
          <div class="info-section">
            <h2 class="section-title">Inquiry Details</h2>
            ${inquiry.budgetRange ? `<p><span class="info-label">Budget Range:</span> <span class="info-value">${inquiry.budgetRange}</span></p>` : ''}
            ${inquiry.applicationNotes ? `<p><span class="info-label">Application Notes:</span> <span class="info-value">${inquiry.applicationNotes}</span></p>` : ''}
            ${inquiry.deliveryAddress ? `<p><span class="info-label">Delivery Address:</span> <span class="info-value">${inquiry.deliveryAddress}</span></p>` : ''}
          </div>
          ` : ''}

          <div class="info-section">
            <h2 class="section-title">Products (${inquiry.totalItems} items)</h2>
            <p>Please find the detailed product list in the attached Excel file.</p>
          </div>

          <div class="whatsapp-section">
            <p style="margin: 0;">üì± Contact customer via WhatsApp</p>
            <p style="margin: 5px 0 0 0; font-size: 14px;">Scan the QR code or click to start a conversation</p>
          </div>
        </div>
        <div class="footer">
          <p><strong>ROWELL HPLC Solutions</strong></p>
          <p>This is an automated notification from your inquiry management system.</p>
          <p style="margin-top: 10px; font-size: 11px;">Please do not reply to this email. For support, contact your system administrator.</p>
        </div>
      </body>
      </html>
    `;

    const msg = {
      to: toEmail,
      from: fromEmail,
      subject: `üîî New Inquiry: ${inquiry.inquiryNumber} - ${user.name || user.email}`,
      text: `New inquiry received from ${user.name} (${user.email})\n\nInquiry Number: ${inquiry.inquiryNumber}\nUrgency: ${inquiry.urgency}\nTotal Items: ${inquiry.totalItems}\n\nPlease check the attached Excel file for details.`,
      html: htmlContent,
      attachments: [
        {
          content: excelBuffer.toString('base64'),
          filename: `Inquiry_${inquiry.inquiryNumber}.xlsx`,
          type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
          disposition: 'attachment',
        },
      ],
    };

    await sgMail.default.send(msg);
    console.log('[Email] ‚úÖ Inquiry notification sent successfully to', toEmail);
    return true;
  } catch (error) {
    console.error('[Email] ‚ùå Failed to send inquiry email:', error);
    return false;
  }
}

/**
 * Send confirmation email to customer
 */
export async function sendCustomerConfirmationEmail(
  inquiry: Inquiry,
  user: User
): Promise<boolean> {
  try {
    console.log('[Email] Customer confirmation email:');
    console.log(`  To: ${user.email}`);
    console.log(`  Subject: Inquiry ${inquiry.inquiryNumber} Received`);
    console.log(`  Customer: ${user.name}`);
    console.log(`  Inquiry Number: ${inquiry.inquiryNumber}`);
    
    // In production, send actual confirmation email to customer
    
    return true;
  } catch (error) {
    console.error('[Email] Failed to send confirmation email:', error);
    return false;
  }
}

